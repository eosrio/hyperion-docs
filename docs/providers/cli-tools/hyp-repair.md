# Repairing Indexed Data (`hyp-repair`)

The `./hyp-repair` tool is a command-line utility designed to diagnose and fix data integrity issues within your Hyperion Elasticsearch indices. Primarily, it addresses two common problems:

1.  **Forked Blocks:** Blocks that were indexed but whose `prev_id` does not correctly link to the `block_id` of the preceding block number in the index. This often happens due to brief network forks where the indexer might initially follow a non-canonical chain segment. While Hyperion's live indexer attempts to handle forks automatically, past issues or interruptions might leave orphaned blocks.
2.  **Missing Blocks:** Gaps in the sequence of indexed blocks, where specific block numbers are entirely absent from the Elasticsearch `*-block-*` indices. This can occur due to indexer interruptions, network issues during indexing, or incomplete historical processing.

!!! attention "Use Cases"
    This tool is typically used when:

    *   You suspect data inconsistency due to past indexing interruptions or known issues (like historical SHIP bugs).
    *   You want to verify the integrity of your indexed block sequence.
    *   You need to recover from a situation where the live indexer's fork handling might not have fully corrected an issue.


## Prerequisites & Preparation

1.  **Hyperion Installation:** Ensure you are running commands from the root directory of your Hyperion installation (e.g., `~/hyperion-history-api`).
2.  **Elasticsearch Connection:** The tool needs direct access to your Elasticsearch cluster as configured in `config/connections.json`.
3.  **Nodeos Connection:** For `scan` and `repair` commands involving fork validation, the tool needs access to the chain's Nodeos HTTP endpoint configured in `config/connections.json` to fetch canonical block information.
4.  **Indexer Control Port Connection:** For the `fill-missing` and `repair` commands (which trigger re-indexing ranges), the tool needs WebSocket access to the running Hyperion Indexer's control port (configured in `config/connections.json` under the chain's `control_port`, default `7002`).
5.  **Backup Elasticsearch (Recommended):** Before running commands that *modify* data (`repair`, `fill-missing`), creating an Elasticsearch snapshot is highly recommended as a safety measure.
6.  **Stop Indexer (Recommended for `repair`):** It is strongly recommended to **stop the relevant Hyperion Indexer (`./stop.sh <chain>-indexer`) before running the `repair` command**, as it performs deletions. Running `fill-missing` might be possible with the indexer running, but stopping it can prevent potential conflicts.

## Workflow Overview

The general workflow for using `hyp-repair` is:

1.  **Scan:** Identify potential issues (forks or missing blocks) within a specified block range.
2.  **Analyze:** Review the output files generated by the scan to understand the scope of the issues.
3.  **Repair:** Execute commands to fix the identified issues (delete forked data, trigger re-indexing of missing ranges).
4.  **Verify:** Re-scan the affected range to confirm the repairs were successful.
5.  **Restart:** Restart the Hyperion Indexer/API if they were stopped.


## Step 1: Scan for Issues

Use the `scan` or `quick-scan` command to check your Elasticsearch indices.

*   **`scan`:** Checks for **both** missing block numbers and block ID mismatches (forks) by comparing consecutive blocks in the index against each other and potentially against the canonical chain via Nodeos RPC. This is more thorough but slower.
*   **`quick-scan`:** Uses Elasticsearch aggregations and a binary search approach primarily to find **missing block number ranges** efficiently. It does *not* validate `block_id` links and won't detect forks as effectively as `scan`. It's much faster for identifying large gaps.

```bash
# Full scan (forks & missing) for 'wax' chain, entire indexed range
./hyp-repair scan wax

# Full scan for 'wax' chain within a specific block range
./hyp-repair scan wax --first 100000000 --last 150000000

# Full scan with custom output file base name and batch size
./hyp-repair scan wax --first 100000000 --last 150000000 --batch 5000 --out-file /tmp/wax-repair-scan

# Quick scan (missing blocks only) for 'eos' chain
./hyp-repair quick-scan eos

# Quick scan with custom output
./hyp-repair quick-scan eos --first 1 --last 200000000 --out-file /repairs/eos-missing
```

*   `--first <number>`: Block number to start scanning from. Defaults to the first block found in Elasticsearch.
*   `--last <number>`: Block number to scan up to. Defaults to the last block found in Elasticsearch.
*   `--batch <number>` (for `scan` only): How many blocks Elasticsearch retrieves per internal query. Default: `2000`.
*   `--out-file <path>`: Base path and filename for the output JSON files (without extension). Defaults to `./.repair/<chain>-<first>-<last>`.

**Output:**
The scan commands generate JSON files detailing the issues found:

*   `<output-path>-forked-blocks.json`: Lists ranges where block linkage (`prev_id` -> `block_id`) is broken. Includes the block IDs identified as non-canonical within that range. Generated only by `scan`.
    ```json
    [
      { "start": 123456, "end": 123458, "ids": ["forked_block_id_1", "forked_block_id_2"] }
    ]
    ```
*   `<output-path>-missing-blocks.json`: Lists ranges of consecutive missing block numbers.
    ```json
    [
      { "start": 10001, "end": 10005, "count": 5 }
    ]
    ```

## Step 2: Analyze Scan Results

Review the generated JSON files to understand the extent of missing or forked data.

Use the `view` command for a formatted table output:
```bash
# View missing blocks file
./hyp-repair view .repair/wax-100000000-150000000-missing-blocks.json

# View forked blocks file
./hyp-repair view .repair/wax-100000000-150000000-forked-blocks.json
```

## Step 3: Repair Issues

!!! warning "Stop Indexer Recommended!"
    Before running `repair`, **stop the corresponding Hyperion Indexer** (`./stop.sh <chain>-indexer`) to prevent data conflicts during deletion and re-indexing.

#### 3.1 Repairing Missing Blocks

The `fill-missing` command instructs the running Hyperion Indexer (via its control port) to fetch and index the block ranges specified in the `-missing-blocks.json` file.

1.  **Test Indexer Connection:** (Optional but recommended)
    ```bash
    # Test connection to default control port (7002) for the 'wax' indexer
    ./hyp-repair connect wax

    # Test connection to a specific host/port
    ./hyp-repair connect wax --host ws://192.168.1.50:7102
    ```
    *   `--host <ws_url>`: Specify if the indexer control port is not on `ws://localhost:<control_port>`.

2.  **Run Fill Command:**
    ```bash
    ./hyp-repair fill-missing <chain> <path-to-missing-blocks.json> [--host <ws_url>] [--dry]

    # Example:
    ./hyp-repair fill-missing wax .repair/wax-100000000-150000000-missing-blocks.json

    # Example with remote indexer:
    ./hyp-repair fill-missing wax .repair/wax-100000000-150000000-missing-blocks.json --host ws://192.168.1.50:7102
    ```
    *   `--dry`: Simulate the process without actually sending commands to the indexer. (Less useful for `fill-missing`).

The tool will send the missing ranges to the indexer in chunks and display progress.

#### 3.2 Repairing Forked Blocks

The `repair` command performs a more complex operation:

*   It reads the `-forked-blocks.json` file.
*   For each range, it **deletes** the identified non-canonical block IDs from the `*-block-*` index in Elasticsearch.
*   It **deletes** all associated actions, deltas, and state table entries (accounts, voters, etc.) within the block number range (`start` to `end`) of the fork from *all relevant indices*.
*   After deletions, it instructs the indexer (via its control port) to re-fetch and re-index the block range (`start` to `end`), effectively replacing the forked data with the canonical data.

!!! warning "Data Deletion"
    This command **permanently deletes data** from your Elasticsearch indices. Always use `--dry` first and ensure you have backups.

1.  **Test Indexer Connection:** (As above)
    ```bash
    ./hyp-repair connect <chain> [--host <ws_url>]
    ```

2.  **Run Dry Run:** **ALWAYS** perform a dry run first to see what would be deleted.
    ```bash
    ./hyp-repair repair <chain> <path-to-forked-blocks.json> --dry

    # Example:
    ./hyp-repair repair wax .repair/wax-100000000-150000000-forked-blocks.json --dry
    ```
    Review the output carefully. It will list the number of documents *proposed* for deletion across different index types (blocks, actions, deltas, state tables).

3.  **Execute Repair:** If the dry run looks correct and the indexer is stopped:
    ```bash
    ./hyp-repair repair <chain> <path-to-forked-blocks.json> [--host <ws_url>]

    # Example:
    ./hyp-repair repair wax .repair/wax-100000000-150000000-forked-blocks.json
    ```
    This will perform the deletions and then trigger the re-indexing via the indexer's control port, showing progress similar to `fill-missing`.

4.  **(Optional) Check Running Tasks:** You can check for long-running Elasticsearch tasks (like `delete_by_query`) using:
    ```bash
    ./hyp-repair repair <chain> <path-to-forked-blocks.json> --check-tasks
    ```

## Step 4: Verify Repair

After the `fill-missing` or `repair` commands complete and the indexer has processed the requested ranges, re-run the `scan` or `quick-scan` command on the same block range(s) to confirm that no further issues are detected.

```bash
# Example re-scan
./hyp-repair scan wax --first 100000000 --last 150000000
```
If the scan reports no errors, the repair was successful.

## Step 5: Restart Services

If you stopped the Hyperion Indexer or API services before the repair, remember to restart them:
```bash
# Example for 'wax' chain
./run.sh wax-indexer
./run.sh wax-api
```

Monitor logs (`pm2 logs <app-name>`) to ensure services start correctly after the repair.









<br>
# Repairing Indexed Data

## Forks and Missed Blocks

After version 3.3.9-5, Hyperion includes a tool to repair indexed data. This tool can be used to fix any unlinked
block (forked)
or missed blocks in the indexer. Usually forks are handled by the indexer itself, but there was an issue with the
state-history plugin in the past, that caused fork events to be omitted during live indexing.
For cases like that and others, this tool can be used to fix the data and check integrity.

### 1. Test the connection

Use the following command to test the connection to the indexer:

```shell
./hyp-repair connect --host "ws://127.0.0.1:7002"
```

7002 is the default port for the indexer control websocket, which can be configured on the connections.json file
under `chains -> YOUR_CHAIN -> control_port`.

!!! success "Connection successful"
    If the connection is successful, you should see the following output:

    ```shell
    ✅  Hyperion Indexer Online - ws://127.0.0.1:7002
    ```

### 2. Scan

Scan for forks or missing blocks

```shell
./hyp-repair scan local
# Specify a range
./hyp-repair scan local --first 1000000 --last 2000000
# Specify the output pathname
./hyp-repair scan local -o ./local
```

If you don't specify a range, the scan will start in reverse, from the last indexed block until the first block in
Elasticsearch.
And if no output path is specified, the scan will be saved in the `.repair` folder.

### 3. Verify the saved scan file

```shell
# Example, your file name may be different
./hyp-repair view .repair/local-4-25334-missing-blocks.json
```

### 4. Request

##### 4.1. Missing blocks

Request the indexer to fill the **missing blocks**:

```shell
# Example, your file name may be different
./hyp-repair fill-missing local .repair/local-4-25334-missing-blocks.json
```

<br>

##### 4.2. Forked blocks

In the case of **forked blocks** (blocks that were indexed but are not linked to the previous block), you can use:

```shell
# Dry-run first to check the proposed removals
./hyp-repair repair local .repair/local-4-25334-forked-blocks.json --dry

# If everything looks good, run the repair
./hyp-repair repair local .repair/local-4-25334-forked-blocks.json
```

**`hyp-repair repair`** will first remove the forked blocks and the corresponding actions, deltas and state tables. Then
it will request the indexer to fill the missing blocks.

!!! success "Verify the results"
    Once the repair is completed, you can run the scan again to verify that there are no more missing blocks or forks.

<br>
